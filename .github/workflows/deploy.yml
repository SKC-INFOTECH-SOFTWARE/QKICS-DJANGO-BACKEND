name: Deploy to VPS

on:
  push:
    branches:
      - main
      - production
  workflow_dispatch:

env:
  DEPLOY_PATH: ${{ secrets.VPS_DEPLOY_PATH }}
  BACKUP_PATH: ${{ secrets.VPS_BACKUP_PATH }}

jobs:

  test:
    runs-on: ubuntu-latest
    if: github.event_name == 'push'

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Lint
        run: |
          pip install flake8
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics || true

  deploy:
    runs-on: ubuntu-latest
    needs: test
    if: github.event_name == 'push'

    steps:
      - uses: actions/checkout@v4

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.VPS_SSH_KEY }}

      - name: Add VPS to known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -T 10 -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts 2>&1 || echo "keyscan failed"
          cat ~/.ssh/known_hosts

      - name: Create release tag
        id: release
        run: |
          TAG="v$(date +%Y%m%d-%H%M%S)"
          echo "tag=$TAG" >> $GITHUB_OUTPUT

      - name: Deploy
        env:
          VPS_USER: ${{ secrets.VPS_USER }}
          VPS_HOST: ${{ secrets.VPS_HOST }}
          RELEASE_TAG: ${{ steps.release.outputs.tag }}
        run: |
          ssh ${VPS_USER}@${VPS_HOST} \
          DEPLOY_PATH="${DEPLOY_PATH}" \
          BACKUP_PATH="${BACKUP_PATH}" \
          RELEASE_TAG="${RELEASE_TAG}" \
          'bash -s' << 'ENDSSH'

          set -e

          echo "=============================="
          echo "Deploying release: $RELEASE_TAG"
          echo "=============================="

          cd $DEPLOY_PATH

          # ==============================
          # BACKUP
          # ==============================
          sudo mkdir -p $BACKUP_PATH
          BACKUP_DIR="$BACKUP_PATH/backup-$(date +%Y%m%d-%H%M%S)"
          sudo mkdir -p $BACKUP_DIR

          echo "Backing up media..."
          sudo rsync -a media/ $BACKUP_DIR/media/ || true

          git rev-parse HEAD > $BACKUP_DIR/git-commit.txt
          echo "$RELEASE_TAG" > $BACKUP_DIR/release-tag.txt

          # ==============================
          # PULL CODE
          # ==============================
          echo "Pulling latest code..."
          git fetch --all --tags
          git pull origin main

          # ==============================
          # BUILD
          # ==============================
          echo "Rebuilding containers..."
          sudo docker-compose -f docker-compose.prod.yml build --no-cache

          # ==============================
          # RESTART
          # Note: entrypoint.sh handles migrate + collectstatic automatically
          # ==============================
          echo "Stopping old containers..."
          sudo docker-compose -f docker-compose.prod.yml down

          echo "Starting containers..."
          sudo docker-compose -f docker-compose.prod.yml up -d

          # ==============================
          # WAIT FOR STARTUP
          # entrypoint.sh runs: migrate -> collectstatic -> gunicorn
          # give it enough time to complete all three
          # ==============================
          echo "Waiting for startup..."
          sleep 60

          # ==============================
          # PERMISSIONS & NGINX
          # ==============================
          echo "Fixing permissions..."
          sudo chown -R www-data:www-data media staticfiles || true

          echo "Reloading nginx..."
          sudo systemctl reload nginx

          # ==============================
          # HEALTH CHECK WITH RETRIES
          # Retries every 10s for up to 100s
          # ==============================
          echo "Running health check..."
          for i in $(seq 1 10); do
            echo "Health check attempt $i/10..."
            if curl -sf http://localhost:9000/api/v1/auth/check-username/; then
              echo ""
              echo "✅ Health check passed!"
              break
            fi
            if [ $i -eq 10 ]; then
              echo "❌ Health check failed after 10 attempts"
              echo "--- Last 50 lines of Django logs ---"
              sudo docker-compose -f docker-compose.prod.yml logs django --tail=50
              exit 1
            fi
            echo "Not ready yet, retrying in 10s..."
            sleep 10
          done

          echo "$RELEASE_TAG" > .current-release

          echo "=============================="
          echo "DEPLOYMENT SUCCESSFUL: $RELEASE_TAG"
          echo "=============================="

          ENDSSH