name: Deploy to VPS

on:
  push:
    branches:
      - main
      - production
  workflow_dispatch:

env:
  DEPLOY_PATH: ${{ secrets.VPS_DEPLOY_PATH }}
  BACKUP_PATH: ${{ secrets.VPS_BACKUP_PATH }}

jobs:

  test:
    runs-on: ubuntu-latest
    if: github.event_name == 'push'

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Lint
        run: |
          pip install flake8
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics || true

  deploy:
    runs-on: ubuntu-latest
    needs: test
    if: github.event_name == 'push'

    steps:
      - uses: actions/checkout@v4

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.VPS_SSH_KEY }}

      - name: Add VPS to known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts

      - name: Create release tag
        id: release
        run: |
          TAG="v$(date +%Y%m%d-%H%M%S)"
          echo "tag=$TAG" >> $GITHUB_OUTPUT

      - name: Deploy
        env:
          VPS_USER: ${{ secrets.VPS_USER }}
          VPS_HOST: ${{ secrets.VPS_HOST }}
          RELEASE_TAG: ${{ steps.release.outputs.tag }}
        run: |
          ssh ${VPS_USER}@${VPS_HOST} \
          DEPLOY_PATH="${DEPLOY_PATH}" \
          BACKUP_PATH="${BACKUP_PATH}" \
          RELEASE_TAG="${RELEASE_TAG}" \
          'bash -s' << 'ENDSSH'

          set -e

          echo "=============================="
          echo "Deploying release: $RELEASE_TAG"
          echo "=============================="

          cd $DEPLOY_PATH

          sudo mkdir -p $BACKUP_PATH
          BACKUP_DIR="$BACKUP_PATH/backup-$(date +%Y%m%d-%H%M%S)"
          sudo mkdir -p $BACKUP_DIR

          echo "Backing up database..."
          sudo mysqldump -u root research_platform_db > $BACKUP_DIR/database.sql || true

          echo "Backing up media..."
          sudo rsync -a media/ $BACKUP_DIR/media/ || true

          git rev-parse HEAD > $BACKUP_DIR/git-commit.txt
          echo "$RELEASE_TAG" > $BACKUP_DIR/release-tag.txt

          echo "Pulling latest code..."
          git fetch --all --tags
          git pull origin main

          echo "Rebuilding containers..."
          sudo docker-compose -f docker-compose.prod.yml build --no-cache

          echo "Stopping old containers..."
          sudo docker-compose -f docker-compose.prod.yml down

          echo "Starting containers..."
          sudo docker-compose -f docker-compose.prod.yml up -d

          echo "Waiting for startup..."
          sleep 12
          

          echo "Running migrations..."
          sudo docker-compose -f docker-compose.prod.yml exec -T django python manage.py migrate --noinput

          echo "Collecting static..."
          sudo docker-compose -f docker-compose.prod.yml exec -T django python manage.py collectstatic --noinput

          echo "Fixing permissions..."
          sudo chown -R www-data:www-data media staticfiles || true

          echo "Reloading nginx..."
          sudo systemctl reload nginx

          echo "Health check..."
          curl -f http://localhost:9000 || exit 1

          echo "$RELEASE_TAG" > .current-release

          echo "=============================="
          echo "DEPLOYMENT SUCCESSFUL"
          echo "=============================="

          ENDSSH
